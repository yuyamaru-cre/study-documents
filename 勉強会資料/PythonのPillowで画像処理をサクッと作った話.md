
### はじめに

*   Pythonで画像処理を行うための強力なライブラリ、Pillow（PILの後継）を紹介します。
*   この資料では、Pillowを活用して、Web API経由で画像編集を行う方法を学びます。

### 今回の題材：画像編集API

*   **主な機能:**
    *   画像のアップロード
    *   画像加工（リサイズ、回転、ぼかし、グレースケール、セピア、オーバーレイなど）
    *   加工済み画像のダウンロード

### ライブラリ選定のポイント

#### OpenCV：高機能だが色の扱いに注意

*   **特徴:**
    *   画像処理、画像解析、機械学習など、多岐にわたる機能を提供
    *   リアルタイム処理に強く、組み込みシステムやロボティクス分野で広く利用
*   **注意点:**
    *   **色の変化:**
        *   画像処理の過程で、明度や彩度が変化しやすい
        *   原因：
            1.  デフォルトの色空間がBGRであること（一般的なRGBと異なる）
            2.  データ型の範囲を超えた演算による色のクリップ
            3.  コーデックによる色の劣化
    *   **対策:**
        *   `cv2.cvtColor()`で色空間を変換
        *   データ型を適切に管理
        *   可逆圧縮形式（PNGなど）を使用
*   **→ 対策が必要で、手間がかかる場合がある**

#### Pillow（PIL）：シンプルで扱いやすい

*   **特徴:**
    *   画像処理に特化しており、シンプルで直感的なAPIを提供
    *   様々な画像形式をサポートし、基本的な画像編集、加工、変換が容易
*   **メリット:**
    *   **色の変化が少ない:**
        *   デフォルトの色空間がRGBであるため、OpenCVのような色空間変換の手間が少ない
        *   色の管理が比較的容易で、意図しない色の変化が起こりにくい
    *   **扱いやすさ:**
        *   APIが直感的で、初心者でも扱いやすい
        *   Webアプリケーションとの連携が容易
*   **→ 色の管理が容易で、Web用途にも適している**

### OpenCV注意点をさらに深掘る

1.  **色空間の変換:**

    *   OpenCVは、画像を読み込む際のデフォルトの色空間がBGR（青、緑、赤）です。一方、Pillowなど他のライブラリや一般的な画像処理ではRGB（赤、緑、青）が使われることが多いです。
    *   この違いにより、色空間の変換を適切に行わないと、色が反転して表示されたり、意図しない色合いになったりすることがあります。
    *   解決策としては、`cv2.cvtColor()`関数を使って、色空間を適切に変換する必要があります。例えば、BGRからRGBに変換するには、`cv2.cvtColor(image, cv2.COLOR_BGR2RGB)`のように記述します。
2.  **データ型の範囲:**

    *   OpenCVで画像を扱う際のデータ型（`dtype`）も重要です。例えば、`uint8`型（0〜255の整数）で画像を扱う場合、演算結果がこの範囲を超えると、値がクリップされたり、ラップアラウンド（最大値を超えると0に戻る）が発生したりします。
    *   これにより、特に明るさやコントラストを調整する際に、色が不自然に変化することがあります。
    *   解決策としては、より広い範囲を表現できるデータ型（例えば`float32`）に変換してから処理を行い、最後に`uint8`に戻すなどの工夫が必要です。
3.  **コーデックの問題:**

    *   画像の保存形式やコーデックによっても、色の再現性が異なる場合があります。特に、JPEG形式は圧縮時に情報が失われるため、画質が劣化しやすく、色味が変わることがあります。
    *   非可逆圧縮であるJPEGを避け、PNGのような可逆圧縮形式を使用することで、色の変化を最小限に抑えることができます。
4.  **ガンマ補正:**

    *   ディスプレイのガンマ特性に合わせて、画像にガンマ補正を適用する必要があります。OpenCVでは、ガンマ補正に関する設定や関数が提供されていないため、必要に応じて自分で実装する必要があります。
    *   ガンマ補正を行わない場合、画像が暗く表示されたり、色合いが不自然になったりすることがあります。

### Pillowライブラリの基本

*   **Pillowとは:**
    *   Python Imaging Library (PIL) の後継として開発された、画像処理ライブラリです。
    *   様々な画像形式をサポートし、画像編集、加工、変換など、豊富な機能を提供します。
*   **主な機能:**
    *   画像の読み込みと保存
    *   画像のリサイズ、回転、切り抜き
    *   色調補正、フィルタ処理
    *   図形描画、テキスト描画
    *   画像形式の変換

### コード解説：画像処理APIの主要部分

1.  **画像の読み込み:**

    ```python
    from PIL import Image

    # 画像ファイルを読み込む
    image = Image.open("image.jpg")
    ```
2.  **画像のリサイズ:**

    ```python
    # 画像サイズを変更する
    resized_image = image.resize((800, 600))  # 幅800px、高さ600pxにリサイズ
    ```
3.  **画像の回転:**

    ```python
    # 画像を回転する
    rotated_image = image.rotate(45)  # 45度回転
    ```
4.  **フィルタ処理:**

    ```python
    from PIL import ImageFilter

    # 画像にぼかしフィルタを適用する
    blurred_image = image.filter(ImageFilter.GaussianBlur(radius=5))
    ```
5.  **画像の色調変換:**

    ```python
    # グレースケールに変換
    grayscale_image = image.convert('L')
    ```
6.  **画像の保存:**

    ```python
    # 処理後の画像を保存する
    resized_image.save("resized_image.jpg")
    ```

### まとめ

*   Pillowライブラリは、Pythonでの画像処理に不可欠なツールです。
*   APIと組み合わせることで、Webアプリケーションやサービスに画像処理機能を簡単に組み込むことができます。
*   非同期処理やメタデータ保持など、実践的なテクニックも重要です。
